name: Release Packages

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        type: string
      create_tag:
        description: "Create git tag"
        required: true
        type: boolean
        default: true

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Validate version format
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi

  create-tag:
    needs: validate
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_tag == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          git tag -a "v${{ needs.validate.outputs.version }}" -m "Release v${{ needs.validate.outputs.version }}"
          git push origin "v${{ needs.validate.outputs.version }}"

  publish-npm:
    needs: validate
    uses: ./.github/workflows/publish-npm.yml
    permissions:
      contents: read
      id-token: write
    with:
      version: ${{ needs.validate.outputs.version }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-kmp:
    needs: validate
    uses: ./.github/workflows/publish-kmp.yml
    permissions:
      contents: read
    with:
      version: ${{ needs.validate.outputs.version }}
    secrets:
      OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
      OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

  create-release:
    needs: [validate, publish-npm, publish-kmp]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download Maven artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-artifacts
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: Release v${{ needs.validate.outputs.version }}
          body: |
            ## ðŸš€ Release v${{ needs.validate.outputs.version }}

            ### ðŸ“¦ npm Package
            ```bash
            npm install @rotesblatt/hex-tractor-data-api@${{ needs.validate.outputs.version }}
            ```

            ### ðŸ“¦ Maven Artifact
            ```xml
            <dependency>
                <groupId>io.github.rotesblatt</groupId>
                <artifactId>hex-tractor-data-api</artifactId>
                <version>${{ needs.validate.outputs.version }}</version>
            </dependency>
            ```

            ```kotlin
            implementation("io.github.rotesblatt:hex-tractor-data-api:${{ needs.validate.outputs.version }}")
            ```

            ---

            **Published to:**
            - npm Registry: https://www.npmjs.com/package/@rotesblatt/hex-tractor-data-api
            - Maven Central: https://central.sonatype.com/artifact/io.github.rotesblatt/hex-tractor-data-api
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          files: artifacts/*
